name: Deploy Spring Boot to AWS EC2 (Gradle)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-22.04  # Ubuntu 22.04 환경에서 실행

    steps:
      ### 📌 1. 레포지토리 체크아웃
      - name: Checkout Repository
        uses: actions/checkout@v4

      ### 📌 2. JDK 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      ### 📌 3. Gradle 권한 부여
      - name: Grant execute permission for Gradle wrapper
        run: chmod +x ./gradlew

      ### 📌 4. Gradle로 애플리케이션 빌드
      - name: Build with Gradle
        run: |
          ./gradlew clean build -x test

      ### 📌 5. 빌드된 JAR 파일 EC2로 전송
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/www/pj9/store"


      - name: Restart Application on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 작업 디렉터리로 이동  
            cd /www/pj9/store/build/libs  
            
            # 기존 Java 프로세스 종료  
            sudo pkill -f 'java -jar' || true  
            
            # JAR 파일 실행 권한 확인 및 부여  
            if [ ! -x "PJ9-0.0.1-SNAPSHOT.jar" ]; then  
              echo "⚠️ JAR 파일에 실행 권한이 없습니다. 권한을 부여합니다."  
              sudo chmod +x PJ9-0.0.1-SNAPSHOT.jar  
            fi  
            
            # Java 버전 확인  
            java -version || { echo "❌ Java가 설치되지 않았습니다."; exit 1; }
            
            # 애플리케이션 실행  
            echo "🚀 애플리케이션을 시작합니다."  
            sudo nohup java -jar PJ9-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
            
            # 실행 확인  
            sleep 5  
            if pgrep -f 'java -jar' > /dev/null; then  
              echo "✅ 애플리케이션이 성공적으로 시작되었습니다."  
            else  
              echo "❌ 애플리케이션 시작 실패."  
              exit 1  
            fi
